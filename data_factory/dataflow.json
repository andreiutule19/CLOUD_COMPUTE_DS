{
    "name": "dataflow1",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "raw_dataset",
                        "type": "DatasetReference"
                    },
                    "name": "source1"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "latest_version",
                        "type": "DatasetReference"
                    },
                    "name": "latest",
                    "rejectedDataLinkedService": {
                        "referenceName": "AzureBlobStorageIuliu",
                        "type": "LinkedServiceReference"
                    }
                },
                {
                    "dataset": {
                        "referenceName": "history",
                        "type": "DatasetReference"
                    },
                    "name": "history",
                    "rejectedDataLinkedService": {
                        "referenceName": "AzureBlobStorageIuliu",
                        "type": "LinkedServiceReference"
                    }
                }
            ],
            "transformations": [
                {
                    "name": "aggregate1"
                },
                {
                    "name": "join1"
                },
                {
                    "name": "aggregate2"
                },
                {
                    "name": "derivedColumn1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          device_id as string,",
                "          timestamp as string,",
                "          kwh as double,",
                "          location as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     ignoreNoFilesFound: false,",
                "     wildcardPaths:['*.csv']) ~> source1",
                "source1 aggregate(groupBy(device_id),",
                "     total_kwh = sum(kwh),",
                "          count = count(1)) ~> aggregate1",
                "source1, aggregate1 join(source1@device_id == aggregate1@device_id,",
                "     joinType:'inner',",
                "     matchType:'exact',",
                "     ignoreSpaces: false,",
                "     broadcast: 'auto')~> join1",
                "join1 aggregate(groupBy(source1@device_id),",
                "     records = collect(concat('{ \"timestamp\": \"',toString(timestamp),'\", \"kwh\": ', toString(kwh),', \"location\": \"',  toString(location) ,'\" }')),",
                "          total_kwh = first(total_kwh),",
                "          count = first(count)) ~> aggregate2",
                "aggregate2 derive(generation_timestamp = currentUTC(),",
                "          latest_filenames = concat('latest/device-', toString(device_id), '.json'),",
                "          historical_filenames = concat('by-timestamp/',toString(currentUTC(), 'yyyy-MM-dd_HHmmss'), '/device-', toString(device_id), '.json')) ~> derivedColumn1",
                "derivedColumn1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     rowUrlColumn:'latest_filenames',",
                "     truncate: true,",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> latest",
                "derivedColumn1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     rowUrlColumn:'historical_filenames',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> history"
            ]
        }
    }
}